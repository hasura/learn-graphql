#for building image
steps:
- name: 'gcr.io/cloud-builders/docker'
  id: build docker image
  args: [ 'build', '-t', '${_IMG_URL}:latest', './${_LOC_URL}/.' ]
#pushing image
- name: 'gcr.io/cloud-builders/docker'
  id: push docker image
  args: [ 'push', '${_IMG_URL}:latest' ]
#change in Deployment file
- name: 'gcr.io/cloud-builders/gcloud'
  id: update image in deployment file
  entrypoint: /bin/sh
  args:
  - '-c'
  - |
        sed -i "s/IMG_PATH/${_IMG_URL}/g" ./k8s-manifest/${_LOC_URL}/k8s/deployment.yaml
#deploy kubernetes manifest
- name: 'gcr.io/cloud-builders/kubectl'
  id: Deploy deployment.yaml
  args: ['apply' , '-f' , './k8s-manifest/${_LOC_URL}/k8s/']
  env:
  - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
  - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTERNAME}'
timeout: 3600s
options:
    dynamic_substitutions: true
    workerPool:
      'projects/${PROJECT_ID}/locations/${_REGION}/workerPools/gke-vpn-pool'